<!DOCTYPE html>
<html lang="de" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Architect by Leon Machnik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        curry: { DEFAULT: '#CB9D2A', 500: '#CB9D2A', 600: '#b88d22' }, 
                        indigo: { DEFAULT: '#002B4F', 900: '#002B4F', 800: '#0b365a' }, 
                        ultramarine: '#254A9A',
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' } 
                    },
                    backgroundImage: {
                        'gradient-mesh': "radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%)",
                        'gradient-light': "radial-gradient(at 0% 0%, hsla(210, 40%, 98%, 1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(42, 100%, 96%, 1) 0, transparent 50%)"
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.5s ease, color 0.3s ease; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Animation Utilities */
        .chevron { transition: transform 0.2s ease; }
        .open .chevron { transform: rotate(180deg); }
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-[#020617] min-h-screen flex flex-col font-sans selection:bg-curry selection:text-white bg-gradient-light dark:bg-gradient-mesh bg-fixed bg-cover text-slate-900 dark:text-slate-100" onload="init()">

    <div class="sticky top-4 z-50 px-4">
        <nav class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/70 border-white/40 dark:bg-[#0f172a]/90 dark:border-white/10 rounded-2xl px-6 py-4 flex justify-between items-center max-w-[1600px] mx-auto">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-900 to-ultramarine flex items-center justify-center text-white shadow-lg ring-1 ring-white/20">
                    <i class="fas fa-cloud text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 dark:text-white tracking-tight leading-none">License Architect</h1>
                    <div class="text-[11px] font-bold text-transparent bg-clip-text bg-gradient-to-r from-curry to-yellow-500 uppercase tracking-wider mt-0.5">by Leon Machnik</div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileSelect(this)">
                
                <div class="hidden md:flex items-center gap-1 bg-slate-100/50 dark:bg-slate-900/50 p-1 rounded-lg border border-slate-200/50 dark:border-white/5 backdrop-blur-sm">
                    <button onclick="document.getElementById('csvInput').click()" class="px-3 py-1.5 text-xs font-semibold rounded-md hover:bg-white dark:hover:bg-slate-700 transition text-slate-600 dark:text-slate-200 flex items-center gap-2">
                        <i class="fas fa-upload"></i> Import
                    </button>
                    <button onclick="exportCSV()" class="px-3 py-1.5 text-xs font-semibold rounded-md hover:bg-white dark:hover:bg-slate-700 transition text-slate-600 dark:text-slate-200 flex items-center gap-2">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full backdrop-blur-md border shadow-sm flex items-center justify-center text-slate-600 dark:text-curry hover:scale-110 transition-transform duration-200 border-slate-200 dark:border-white/10 bg-white/50 dark:bg-slate-800/80">
                    <i class="fas fa-sun hidden dark:block text-yellow-400"></i>
                    <i class="fas fa-moon dark:hidden"></i>
                </button>
            </div>
        </nav>
    </div>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-[1600px]">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
            
            <div class="xl:col-span-7 space-y-6 fade-in-up" style="animation-delay: 0.1s;">
                
                <div class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl p-8 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-indigo-900 to-ultramarine"></div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-sm font-bold text-slate-900 dark:text-white uppercase flex items-center gap-3 tracking-wider">
                            <span class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-300"><i class="fas fa-id-badge"></i></span>
                            1. Profile & Context
                        </h2>
                        <button onclick="resetForm()" class="text-[10px] uppercase font-bold tracking-wider text-slate-400 hover:text-red-500 transition flex items-center gap-1.5 bg-slate-100 dark:bg-slate-800/50 px-3 py-1.5 rounded-md border border-slate-200 dark:border-slate-700">
                            <i class="fas fa-eraser"></i> Clear Form
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                        
                        <div class="md:col-span-12 mb-2">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between bg-slate-100 dark:bg-slate-900/50 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                                 <div class="flex flex-col mb-2 sm:mb-0">
                                    <span class="text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 tracking-widest">Commitment Term</span>
                                    <span class="text-xs text-slate-700 dark:text-slate-300 font-medium">NCE Pricing Model</span>
                                 </div>
                                 <div class="flex items-center bg-white dark:bg-slate-950 rounded-lg p-1 border border-slate-200 dark:border-slate-700 shadow-sm">
                                    <button onclick="setTerm('annual')" id="btnAnnual" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-indigo-900 text-white shadow-md ring-1 ring-black/5">Annual</button>
                                    <button onclick="setTerm('monthly')" id="btnMonthly" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-800">Monthly (+20%)</button>
                                 </div>
                            </div>
                        </div>

                        <div class="md:col-span-6">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1.5 uppercase tracking-widest">Persona Name</label>
                            <input type="text" id="personaName" placeholder="e.g. Marketing Lead" 
                                class="w-full rounded-lg border-0 px-3 py-2.5 shadow-inner ring-1 ring-inset focus:ring-2 focus:ring-inset focus:ring-curry sm:text-sm sm:leading-6 transition-all bg-white/80 text-slate-900 ring-gray-300 placeholder:text-gray-400 dark:bg-slate-950 dark:text-white dark:ring-slate-700 dark:placeholder-slate-500">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1.5 uppercase tracking-widest">Qty</label>
                            <input type="number" id="userCount" value="10" min="1" oninput="recalc()"
                                class="w-full rounded-lg border-0 px-3 py-2.5 shadow-inner ring-1 ring-inset focus:ring-2 focus:ring-inset focus:ring-curry transition-all bg-white/80 text-slate-900 ring-gray-300 placeholder:text-gray-400 dark:bg-slate-950 dark:text-white dark:ring-slate-700 dark:placeholder-slate-500">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1.5 uppercase tracking-widest">Workstyle</label>
                            <select id="workstyle" onchange="recalc()"
                                class="w-full rounded-lg border-0 px-3 py-2.5 shadow-inner ring-1 ring-inset focus:ring-2 focus:ring-inset focus:ring-curry transition-all bg-white/80 text-slate-900 ring-gray-300 placeholder:text-gray-400 dark:bg-slate-950 dark:text-white dark:ring-slate-700 dark:placeholder-slate-500">
                                <option value="office">Office</option>
                                <option value="frontline">Frontline</option>
                                <option value="standalone">Standalone / Add-ons</option>
                            </select>
                        </div>
                        <div class="md:col-span-12">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1.5 uppercase tracking-widest">Current License (For Comparison)</label>
                            <select id="currentLicense" onchange="recalc()"
                                class="w-full rounded-lg border-0 px-3 py-2.5 shadow-inner ring-1 ring-inset focus:ring-2 focus:ring-inset focus:ring-curry transition-all bg-white/80 text-slate-900 ring-gray-300 placeholder:text-gray-400 dark:bg-slate-950 dark:text-white dark:ring-slate-700 dark:placeholder-slate-500">
                                <option value="None">-- New Hire / No License --</option>
                                <option value="M365 F1">Microsoft 365 F1</option>
                                <option value="M365 F3">Microsoft 365 F3</option>
                                <option value="Business Basic">Business Basic</option>
                                <option value="Business Standard">Business Standard</option>
                                <option value="Business Premium">Business Premium</option>
                                <option value="O365 E1">Office 365 E1</option>
                                <option value="O365 E3">Office 365 E3</option>
                                <option value="M365 E3">Microsoft 365 E3</option>
                                <option value="M365 E5">Microsoft 365 E5</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl p-6 fade-in-up border-l-4 border-l-curry" style="animation-delay: 0.2s;">
                        <h3 class="text-xs font-bold text-slate-400 dark:text-slate-400 uppercase mb-4 flex items-center gap-2 tracking-wide"><i class="fas fa-rocket text-curry"></i> 2. Productivity</h3>
                        <div class="space-y-4">
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200 group-hover:text-curry transition">Mailbox > 0GB</span>
                                <input type="checkbox" id="needMailbox" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200 group-hover:text-curry transition">Large Mailbox (50GB+)</span>
                                <input type="checkbox" id="largeMailbox" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200 group-hover:text-curry transition">Desktop Apps</span>
                                <input type="checkbox" id="desktopApps" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200 group-hover:text-curry transition">Web Editing</span>
                                <input type="checkbox" id="webEdit" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <div class="h-px bg-slate-200 dark:bg-white/10 my-2"></div>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-bold text-indigo-600 dark:text-indigo-300">Teams Collaboration</span>
                                <input type="checkbox" id="teamsCollab" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200 group-hover:text-curry transition">Teams Phone</span>
                                <input type="checkbox" id="teamsPhone" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                        </div>
                    </div>

                    <div class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl p-6 fade-in-up border-l-4 border-l-curry" style="animation-delay: 0.3s;">
                        <h3 class="text-xs font-bold text-slate-400 dark:text-slate-400 uppercase mb-4 flex items-center gap-2 tracking-wide"><i class="fas fa-laptop text-curry"></i> 3. Endpoint & OS</h3>
                        <div class="space-y-4">
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Mobile MDM</span>
                                <input type="checkbox" id="mdmMobile" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Desktop MDM (Intune)</span>
                                <input type="checkbox" id="mdmDesktop" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Windows OS (E3/E5)</span>
                                <input type="checkbox" id="winOS" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <div class="h-px bg-slate-200 dark:bg-white/10 my-2"></div>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Defender P1 (AV)</span>
                                <input type="checkbox" id="sec_def_p1" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Defender P2 (XDR)</span>
                                <input type="checkbox" id="sec_def_p2" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                        </div>
                    </div>

                    <div class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl p-6 fade-in-up border-l-4 border-l-curry" style="animation-delay: 0.4s;">
                        <h3 class="text-xs font-bold text-slate-400 dark:text-slate-400 uppercase mb-4 flex items-center gap-2 tracking-wide"><i class="fas fa-shield-alt text-curry"></i> 4. Security</h3>
                        <div class="space-y-4">
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Cond. Access (P1)</span>
                                <input type="checkbox" id="sec_ca" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Risk-Based CA (P2)</span>
                                <input type="checkbox" id="sec_risk_ca" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Cloud Apps (CASB)</span>
                                <input type="checkbox" id="sec_casb" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                        </div>
                    </div>

                    <div class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl p-6 fade-in-up border-l-4 border-l-curry" style="animation-delay: 0.5s;">
                        <h3 class="text-xs font-bold text-slate-400 dark:text-slate-400 uppercase mb-4 flex items-center gap-2 tracking-wide"><i class="fas fa-file-contract text-curry"></i> 5. Compliance</h3>
                        <div class="space-y-4">
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">DLP (Basic/Full)</span>
                                <input type="checkbox" id="comp_dlp" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Auto Labeling</span>
                                <input type="checkbox" id="comp_labeling" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                            <label class="flex justify-between items-center cursor-pointer group">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Adv. eDiscovery</span>
                                <input type="checkbox" id="comp_ediscovery" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl overflow-hidden fade-in-up border-l-4 border-l-curry" style="animation-delay: 0.6s;">
                    <div onclick="toggleCollapse('advancedAddons')" class="flex justify-between items-center p-5 cursor-pointer hover:bg-white/50 dark:hover:bg-slate-700/50 transition">
                        <h3 class="text-xs font-bold text-slate-500 dark:text-slate-300 uppercase flex items-center gap-2 tracking-wide"><i class="fas fa-wand-magic-sparkles text-curry"></i> 6. Advanced Cloud & AI</h3>
                        <i class="fas fa-chevron-down text-slate-400 chevron"></i>
                    </div>
                    <div id="advancedAddons" class="hidden p-6 border-t border-slate-200 dark:border-slate-700 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50/50 dark:bg-slate-800/50">
                        <div>
                            <h4 class="text-[10px] font-bold uppercase text-indigo-600 dark:text-indigo-300 mb-3 tracking-widest">Intune Suite</h4>
                            <div class="space-y-3">
                                <label class="flex justify-between items-center cursor-pointer"><span class="text-sm text-slate-700 dark:text-slate-200">EPM (€5.50)</span><input type="checkbox" id="adv_epm" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()"></label>
                                <label class="flex justify-between items-center cursor-pointer"><span class="text-sm text-slate-700 dark:text-slate-200">Remote Help (€5.50)</span><input type="checkbox" id="adv_remotehelp" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()"></label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-[10px] font-bold uppercase text-pink-500 dark:text-pink-400 mb-3 tracking-widest">AI / Copilot</h4>
                            <label class="flex justify-between items-center cursor-pointer"><span class="text-sm text-slate-700 dark:text-slate-200 font-semibold">M365 Copilot (€30)</span><input type="checkbox" id="adv_copilot" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()"></label>
                        </div>
                    </div>
                </div>

                <div class="backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl overflow-hidden fade-in-up border-l-4 border-l-curry" style="animation-delay: 0.7s;">
                    <div onclick="toggleCollapse('additionalProds')" class="flex justify-between items-center p-5 cursor-pointer hover:bg-white/50 dark:hover:bg-slate-700/50 transition">
                        <h3 class="text-xs font-bold text-slate-500 dark:text-slate-300 uppercase flex items-center gap-2 tracking-wide"><i class="fas fa-cubes text-curry"></i> 7. Additional Products</h3>
                        <i class="fas fa-chevron-down text-slate-400 chevron"></i>
                    </div>
                    <div id="additionalProds" class="hidden p-6 border-t border-slate-200 dark:border-slate-700 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50/50 dark:bg-slate-800/50">
                        <div>
                            <h4 class="text-[10px] font-bold uppercase text-emerald-600 dark:text-emerald-400 mb-3 tracking-widest">Visio & Project</h4>
                            <div class="space-y-3">
                                <label class="flex justify-between items-center cursor-pointer">
                                    <span class="text-sm text-slate-700 dark:text-slate-200">Visio Plan 2 (€12.70)</span>
                                    <input type="checkbox" id="add_visio" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                                </label>
                                <label class="flex justify-between items-center cursor-pointer">
                                    <span class="text-sm text-slate-700 dark:text-slate-200">Project Plan 3 (€25.30)</span>
                                    <input type="checkbox" id="add_project" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                                </label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-[10px] font-bold uppercase text-orange-500 dark:text-orange-400 mb-3 tracking-widest">Infra, Power & Rooms</h4>
                            <div class="space-y-3">
                                <label class="flex justify-between items-center cursor-pointer">
                                    <span class="text-sm text-slate-700 dark:text-slate-200">Power Auto. Prem. (€14)</span>
                                    <input type="checkbox" id="add_powerauto" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                                </label>
                                <label class="flex justify-between items-center cursor-pointer">
                                    <span class="text-sm text-slate-700 dark:text-slate-200">Teams Rooms Pro (€33.70)</span>
                                    <input type="checkbox" id="add_rooms" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                                </label>
                                <label class="flex justify-between items-center cursor-pointer">
                                    <span class="text-sm text-slate-700 dark:text-slate-200">Defender Server (€2.80)</span>
                                    <input type="checkbox" id="serverProt" class="h-5 w-5 rounded border-gray-300 text-curry focus:ring-curry dark:border-slate-600 dark:bg-slate-950 dark:checked:bg-curry accent-curry cursor-pointer" onchange="recalc()">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="xl:col-span-5">
                <div class="sticky top-24 space-y-6 fade-in-up" style="animation-delay: 0.4s;">
                    
                    <div class="rounded-[2rem] shadow-2xl overflow-hidden bg-white dark:bg-[#0f172a] border border-white/20 dark:border-slate-700 relative transition-all group hover:shadow-curry/20 duration-500">
                        <div class="bg-gradient-to-br from-indigo-900 to-indigo-800 p-10 text-white relative overflow-hidden">
                            <div class="absolute -right-10 -top-10 w-48 h-48 bg-curry rounded-full blur-[90px] opacity-30 animate-pulse"></div>
                            <div class="absolute -left-10 bottom-0 w-40 h-40 bg-blue-500 rounded-full blur-[70px] opacity-20"></div>
                            
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="text-[10px] font-bold uppercase tracking-[0.2em] text-white/70">Recommended License</div>
                                    <i class="fas fa-award text-curry text-xl"></i>
                                </div>
                                <h2 class="text-5xl font-extrabold leading-none tracking-tight mb-3" id="recName">--</h2>
                                <div class="text-sm font-medium text-yellow-400" id="recAddon"></div>
                                
                                <div class="mt-8 pt-6 border-t border-white/10 flex justify-between items-end">
                                    <div class="text-xs font-medium text-white/60 uppercase tracking-wider">Est. Monthly / User</div>
                                    <div class="text-right">
                                        <div class="text-5xl font-bold text-white tracking-tight font-mono" id="recPrice">€0.00</div>
                                        <div class="text-xs font-bold mt-1" id="priceDelta">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-50/80 dark:bg-[#0f172a] px-10 py-5 border-b border-slate-200 dark:border-slate-700 backdrop-blur-sm">
                            <div class="flex flex-wrap gap-2" id="featureTags"></div>
                        </div>

                        <div class="p-10 bg-white dark:bg-[#0f172a]">
                            <h3 class="text-xs font-bold text-slate-400 dark:text-slate-400 uppercase mb-4 tracking-widest">Reasoning</h3>
                            <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-200 mb-8 bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-white/5" id="recReason">Select your requirements to begin...</p>
                            
                            <div class="rounded-xl bg-slate-100/80 dark:bg-slate-950 p-5 border border-slate-200 dark:border-slate-700 flex justify-between items-center">
                                <div>
                                    <span class="text-[10px] font-bold uppercase text-slate-400 block mb-0.5 tracking-wider">Runner Up</span>
                                    <span class="text-sm font-bold text-slate-700 dark:text-white" id="altName">--</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-full bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700" id="altDiff">--</span>
                                    <div class="text-xs font-mono text-slate-400 mt-1" id="altPrice">--</div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-slate-50 dark:bg-[#0f172a] border-t border-slate-200 dark:border-slate-700">
                            <button id="actionBtn" onclick="addToQuote()" class="bg-gradient-to-r from-curry via-yellow-500 to-curry text-white font-bold shadow-lg hover:shadow-curry/50 hover:scale-[1.02] transition-all duration-200 w-full py-4 rounded-xl text-sm uppercase tracking-[0.15em] flex justify-center items-center gap-3 group">
                                <i class="fas fa-plus-circle text-lg group-hover:rotate-90 transition-transform duration-300"></i> <span id="actionBtnText">Add to Quote</span>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="mt-12 backdrop-blur-xl border shadow-2xl transition-all duration-300 bg-white/65 border-white/40 dark:bg-[#0f172a]/95 dark:border-white/10 rounded-3xl p-10 fade-in-up" style="animation-delay: 0.6s;">
            <div class="flex justify-between items-center mb-8">
                <h3 class="font-bold text-2xl text-slate-900 dark:text-white"><i class="fas fa-file-invoice text-curry mr-3"></i> Quote Summary</h3>
                <div class="text-sm font-mono bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-lg text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700" id="quoteCount">0 Personas</div>
            </div>
            
            <div class="overflow-hidden rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 dark:bg-[#020617] text-xs uppercase font-bold text-slate-500 dark:text-slate-400">
                        <tr>
                            <th class="px-6 py-5">Persona</th>
                            <th class="px-6 py-5">Base</th>
                            <th class="px-6 py-5 w-full">Add-ons</th>
                            <th class="px-6 py-5 text-right">Price</th>
                            <th class="px-6 py-5 text-right">Total</th>
                            <th class="px-6 py-5 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="quoteBody" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-[#0f172a] text-slate-700 dark:text-slate-200">
                        <tr><td colspan="6" class="px-6 py-16 text-center text-slate-400 italic">No personas added. Build your quote above.</td></tr>
                    </tbody>
                    <tfoot class="bg-slate-50 dark:bg-[#020617] font-bold text-slate-900 dark:text-white border-t-2 border-slate-200 dark:border-slate-700">
                        <tr>
                            <td colspan="4" class="text-right px-6 py-5 uppercase text-xs tracking-wider">Monthly Total:</td>
                            <td class="text-right text-curry text-2xl px-6 py-5 font-mono" id="grandTotal">€0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 fade-in-up" id="costDashboard" style="display: none;">
                <div class="bg-slate-100 dark:bg-slate-900/50 rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-end mb-2">
                        <div class="text-xs font-bold uppercase text-indigo-900 dark:text-indigo-300">Base Licenses</div>
                        <div class="text-sm font-mono font-bold text-indigo-700 dark:text-indigo-400" id="dashBaseVal">€0.00</div>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-800 rounded-full h-3 overflow-hidden">
                        <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500" id="dashBaseBar" style="width: 0%"></div>
                    </div>
                    <div class="text-[10px] text-right mt-1 text-slate-500" id="dashBasePct">0%</div>
                </div>
                
                <div class="bg-slate-100 dark:bg-slate-900/50 rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-end mb-2">
                        <div class="text-xs font-bold uppercase text-curry-600 dark:text-yellow-500">Add-ons & Upgrades</div>
                        <div class="text-sm font-mono font-bold text-curry-600 dark:text-yellow-500" id="dashAddonVal">€0.00</div>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-800 rounded-full h-3 overflow-hidden">
                        <div class="bg-curry h-3 rounded-full transition-all duration-500" id="dashAddonBar" style="width: 0%"></div>
                    </div>
                    <div class="text-[10px] text-right mt-1 text-slate-500" id="dashAddonPct">0%</div>
                </div>
            </div>

        </div>
    </main>

    <div id="compModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-[101] overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-3xl w-full border border-white/10 transition-all transform scale-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-900 to-indigo-800 px-10 py-8 flex justify-between items-center relative">
                         <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-curry to-yellow-500"></div>
                        <h3 id="modalTitle" class="text-white font-bold text-2xl tracking-wide">License Comparison</h3>
                        <button onclick="closeModal()" class="text-white/70 hover:text-white transition bg-white/10 hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="p-10">
                        <div class="grid grid-cols-2 gap-8 mb-10">
                            <div class="text-center p-6 rounded-2xl border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-[#020617] relative overflow-hidden">
                                <div class="text-[10px] uppercase text-slate-500 font-bold tracking-widest mb-2">Current</div>
                                <div class="font-bold text-xl text-slate-800 dark:text-white" id="modCurrentName">--</div>
                            </div>
                            <div class="text-center p-6 rounded-2xl border border-indigo-200 bg-indigo-50 dark:border-indigo-900 dark:bg-indigo-950 relative overflow-hidden ring-1 ring-indigo-500/30">
                                <div class="absolute top-0 right-0 p-2 text-indigo-200 opacity-20 text-4xl"><i class="fas fa-arrow-right"></i></div>
                                <div class="text-[10px] uppercase text-indigo-600 dark:text-indigo-300 font-bold tracking-widest mb-2">Recommended</div>
                                <div class="font-bold text-xl text-indigo-700 dark:text-white" id="modRecName">--</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div class="bg-green-50/50 dark:bg-green-900/10 p-6 rounded-2xl border border-green-100 dark:border-green-900/30">
                                <h4 class="text-xs font-bold text-green-700 dark:text-green-400 uppercase mb-4 border-b border-green-200 dark:border-green-800 pb-3 flex items-center gap-2"><i class="fas fa-plus-circle"></i> Gained Features</h4>
                                <ul id="listGained" class="text-sm space-y-3 text-slate-700 dark:text-slate-300"></ul>
                            </div>
                            <div class="bg-red-50/50 dark:bg-red-900/10 p-6 rounded-2xl border border-red-100 dark:border-red-900/30">
                                <h4 class="text-xs font-bold text-red-700 dark:text-red-400 uppercase mb-4 border-b border-red-200 dark:border-red-800 pb-3 flex items-center gap-2"><i class="fas fa-minus-circle"></i> Lost Features</h4>
                                <ul id="listLost" class="text-sm space-y-3 text-slate-700 dark:text-slate-300"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-900 px-10 py-6 flex justify-end border-t border-slate-200 dark:border-slate-700">
                        <button onclick="closeModal()" class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-8 py-3 rounded-xl font-bold text-sm hover:scale-105 transition transform shadow-lg">Done</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const PRICES = {
            "None": 0,
            "M365 F1": 1.60, "M365 F3": 7.00, 
            "Business Basic": 4.60, "Business Standard": 9.70, "Business Premium": 18.60,
            "O365 E1": 7.40, "O365 E3": 23.10, 
            "M365 E3": 29.70, "M365 E5": 51.70,
            "Entra ID P2": 8.40, "M365 E5 Security Add-on": 11.20, "M365 E5 Compliance Add-on": 11.20, 
            "M365 F5 Security Add-on": 8.00, "M365 F5 Compliance Add-on": 8.00,
            "Defender for Business Servers": 2.80,
            "Intune Suite Add-on": 9.40, "EPM Add-on": 5.50, "Remote Help Add-on": 5.50,
            "M365 Copilot": 30.00,
            "Visio Plan 2": 12.70, "Project Plan 3": 25.30,
            "Power Automate Premium": 14.00, "Teams Rooms Pro": 33.70,
            // NEW BUSINESS PREMIUM UPGRADES
            "Defender Suite for BizPrem": 10.00,
            "Purview Suite for BizPrem": 10.00,
            "BizPrem E5 Upgrade": 15.00,
            // TEAMS
            "Teams_F": 0.50, "Teams_BizBasic": 1.00, "Teams_BizStd": 2.00, "Teams_BizPrem": 2.00,
            "Teams_E1": 1.00, "Teams_OE3": 8.30, "Teams_ME3": 8.00, "Teams_ME5": 8.00
        };

        const HIERARCHY = {
            "Mail": ["2GB Mail", "Exch 50GB", "Exch 100GB"],
            "Apps": ["Web Apps (Read-Only)", "Web Apps (Edit)", "Desktop Apps"],
            "Entra": ["Entra P1", "Entra P2"],
            "Def": ["Def Biz", "Def P1", "Def XDR"],
            "Comp": ["Comp Basic", "Comp E5"],
            "Teams": ["No Teams", "Teams Collaboration", "Teams Phone"],
            "MDM": ["Mobile MDM", "Intune"]
        };

        const FEATURES_MAP = {
            "None": [],
            "M365 F1": ["Intune", "Entra P1", "Teams Collaboration", "Web Apps (Read-Only)", "2GB Mail"],
            "M365 F3": ["Intune", "Entra P1", "Teams Collaboration", "Web Apps (Edit)", "Win OS Kiosk", "2GB Mail"],
            "Business Basic": ["Web Apps (Edit)", "Exch 50GB", "SharePoint", "Teams Collaboration"],
            "Business Standard": ["Desktop Apps", "Web Apps (Edit)", "Exch 50GB", "SharePoint", "Teams Collaboration"],
            "Business Premium": ["Intune", "Def Biz", "Entra P1", "Desktop Apps", "Web Apps (Edit)", "Exch 50GB", "SharePoint", "Teams Collaboration", "Win OS (VDA)"],
            "O365 E1": ["Web Apps (Edit)", "Exch 50GB", "SharePoint", "Teams Collaboration"],
            "O365 E3": ["Desktop Apps", "Web Apps (Edit)", "Exch 100GB", "SharePoint", "Comp Basic", "Teams Collaboration"],
            "M365 E3": ["Win OS", "Intune", "Entra P1", "Desktop Apps", "Web Apps (Edit)", "Exch 100GB", "SharePoint", "Def P1", "Comp Basic", "No Teams"], 
            "M365 E5": ["Win OS", "Intune", "Entra P2", "Desktop Apps", "Web Apps (Edit)", "Exch 100GB", "SharePoint", "Def XDR", "Comp E5", "PowerBI", "Teams Phone", "No Teams"]
        };

        // IDs for Form Persistence
        const FORM_IDS = [
            'personaName', 'userCount', 'workstyle', 'currentLicense', 
            'needMailbox', 'largeMailbox', 'desktopApps', 'webEdit', 
            'teamsCollab', 'teamsPhone', 
            'mdmMobile', 'mdmDesktop', 'winOS', 
            'sec_def_p1', 'sec_def_p2', 'sec_ca', 'sec_risk_ca', 'sec_casb', 
            'comp_dlp', 'comp_labeling', 'comp_ediscovery', 
            'adv_epm', 'adv_remotehelp', 'adv_copilot', 
            'add_visio', 'add_project', 'add_powerauto', 'add_rooms', 'serverProt'
        ];

        let quoteItems = [];
        let currentCalc = {};
        let isMonthly = false;
        let editingIndex = -1; // -1 means adding new, >= 0 means editing index

        function init() {
            // System Theme Listener
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', e => {
                if (!('theme' in localStorage)) {
                    if (e.matches) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                }
            });
            
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && mediaQuery.matches)) {
                document.documentElement.classList.add('dark');
            }
            recalc();
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const parent = el.parentElement;
            el.classList.toggle('hidden');
            parent.classList.toggle('open');
            const chev = parent.querySelector('.chevron');
            if(chev) chev.style.transform = el.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        function setTerm(term) {
            const btnA = document.getElementById('btnAnnual');
            const btnM = document.getElementById('btnMonthly');
            
            if(term === 'annual') {
                isMonthly = false;
                btnA.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-indigo-900 text-white shadow-md ring-1 ring-black/5";
                btnM.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-800";
            } else {
                isMonthly = true;
                btnM.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-indigo-900 text-white shadow-md ring-1 ring-black/5";
                btnA.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-800";
            }
            recalc();
        }

        function resetForm() {
            FORM_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.type === 'checkbox') el.checked = false;
                else if (el.tagName === 'SELECT') el.selectedIndex = 0;
                else el.value = '';
            });
            // Set defaults
            document.getElementById('userCount').value = 10;
            document.getElementById('workstyle').value = 'office';
            document.getElementById('currentLicense').value = 'None';
            
            // Exit edit mode
            editingIndex = -1;
            updateActionButton();
            
            recalc();
        }

        function editPersona(idx) {
            const item = quoteItems[idx];
            if (!item.inputs) return alert("Cannot edit items created with an older version.");
            
            // Restore inputs
            FORM_IDS.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                const savedVal = item.inputs[id];
                if (el.type === 'checkbox') el.checked = savedVal;
                else el.value = savedVal;
            });

            // Set edit mode
            editingIndex = idx;
            updateActionButton();
            
            // Update calculation based on loaded values
            recalc();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateActionButton() {
            const btn = document.getElementById('actionBtn');
            const txt = document.getElementById('actionBtnText');
            
            if (editingIndex > -1) {
                txt.innerText = "Update Persona";
                btn.className = "bg-gradient-to-r from-blue-600 via-indigo-600 to-blue-600 text-white font-bold shadow-lg hover:shadow-indigo-500/50 hover:scale-[1.02] transition-all duration-200 w-full py-4 rounded-xl text-sm uppercase tracking-[0.15em] flex justify-center items-center gap-3 group";
            } else {
                txt.innerText = "Add to Quote";
                btn.className = "bg-gradient-to-r from-curry via-yellow-500 to-curry text-white font-bold shadow-lg hover:shadow-curry/50 hover:scale-[1.02] transition-all duration-200 w-full py-4 rounded-xl text-sm uppercase tracking-[0.15em] flex justify-center items-center gap-3 group";
            }
        }

        function recalc() {
            // Build input object dynamically based on FORM_IDS to save state later
            const i = {
                count: parseInt(document.getElementById('userCount').value) || 1,
                style: document.getElementById('workstyle').value,
                current: document.getElementById('currentLicense').value,
                desktop: document.getElementById('desktopApps').checked,
                web: document.getElementById('webEdit').checked,
                teams: document.getElementById('teamsCollab').checked,
                phone: document.getElementById('teamsPhone').checked,
                mdm: document.getElementById('mdmMobile').checked || document.getElementById('mdmDesktop').checked,
                win: document.getElementById('winOS').checked,
                ca: document.getElementById('sec_ca').checked,
                risk: document.getElementById('sec_risk_ca').checked,
                def1: document.getElementById('sec_def_p1').checked,
                def2: document.getElementById('sec_def_p2').checked,
                casb: document.getElementById('sec_casb').checked,
                dlp: document.getElementById('comp_dlp').checked,
                lbl: document.getElementById('comp_labeling').checked,
                edisc: document.getElementById('comp_ediscovery').checked,
                epm: document.getElementById('adv_epm').checked,
                rh: document.getElementById('adv_remotehelp').checked,
                copilot: document.getElementById('adv_copilot').checked,
                visio: document.getElementById('add_visio').checked,
                project: document.getElementById('add_project').checked,
                pauto: document.getElementById('add_powerauto').checked,
                rooms: document.getElementById('add_rooms').checked,
                serverProt: document.getElementById('serverProt').checked 
            };

            // NCE Multiplier Logic
            const mult = isMonthly ? 1.2 : 1.0;

            let base = "None";
            let addons = [];
            let reason = "";
            let alt = "";

            const needsAdvSec = i.risk || i.def2 || i.casb || i.phone;
            const needsAdvComp = i.lbl || i.edisc;
            const needsIntuneAdv = i.epm || i.rh;

            // Base Logic
            if (i.style === 'standalone') {
                base = "None";
                reason = "Standalone Mode: Only selected Add-ons are calculated.";
                alt = "None"; 
            } else {
                if (i.copilot) {
                     base = "M365 E3"; reason = "M365 Copilot selected: Requires E3/E5."; alt = "M365 E5";
                } else if (needsIntuneAdv && (i.current === "None" || i.current.includes("Business") || i.current.includes("F") || i.current.includes("O365"))) {
                     base = "M365 E3"; reason = "Intune Suite Add-ons need M365 E3 base."; alt = "Business Premium";
                } else {
                    if (i.style === 'frontline') {
                        if (i.phone || i.win || needsIntuneAdv) {
                            base = "M365 E5"; reason = "Frontline needs Ent. features (Voice/Win/Intune Suite)."; alt = "M365 F3";
                        } else if (i.desktop) {
                            base = "M365 E3"; reason = "Desktop Apps not in F-SKU."; alt = "M365 F3";
                        } else {
                            base = i.web ? "M365 F3" : "M365 F1";
                            reason = i.web ? "F3 for Web Edit." : "F1 for Read-only.";
                            alt = i.web ? "M365 F1" : "M365 F3";
                            if (needsAdvSec) addons.push("M365 F5 Security Add-on"); 
                        }
                    } else {
                        // Logic Updated: Prefer Business Premium if count <= 300 even for Adv Security
                        if (i.mdm || i.win || i.ca || i.def1 || needsIntuneAdv || needsAdvSec || needsAdvComp) {
                            if (i.count <= 300 && !i.phone) { // BP limit & Phone check
                                base = "Business Premium"; 
                                reason = "SMB High Security (BizPrem + Add-ons)."; 
                                alt = "M365 E5";
                            } else {
                                // If > 300 or needs Phone (Ent Voice), jump to E5 logic
                                if (needsAdvSec || needsAdvComp || i.phone) {
                                    base = "M365 E5"; reason = "E5 required (Security/Comp/Voice or >300 users)."; alt = "M365 E3";
                                } else {
                                    base = "M365 E3"; reason = "Enterprise Standard (Intune/Sec)."; alt = "Business Premium";
                                }
                            }
                        } else if (i.desktop) {
                            base = i.count < 300 ? "Business Standard" : "O365 E3";
                            reason = "Desktop Apps req.";
                            alt = i.count < 300 ? "Business Basic" : "O365 E1";
                        } else {
                            base = i.count < 300 ? "Business Basic" : "O365 E1";
                            reason = "Cloud only.";
                            alt = "Business Standard";
                        }
                    }
                }
            }

            // Teams Logic
            let tPrice = 0;
            if (i.teams) {
                let k = "";
                if (base.includes("F1") || base.includes("F3")) k = "Teams_F";
                else if (base.includes("Basic")) k = "Teams_BizBasic";
                else if (base.includes("Standard")) k = "Teams_BizStd";
                else if (base.includes("Premium")) k = "Teams_BizPrem";
                else if (base.includes("O365 E1")) k = "Teams_E1";
                else if (base.includes("O365 E3")) k = "Teams_OE3";
                else if (base.includes("M365 E3")) k = "Teams_ME3";
                else if (base.includes("M365 E5")) k = "Teams_ME5";
                tPrice = (PRICES[k] || 0) * mult; // Apply Mult
                if (tPrice > 0) addons.push({name: "Teams EEA", price: tPrice});
            }

            // Intune Logic
            if (i.epm || i.rh) {
                let indCost = ((i.epm ? PRICES["EPM Add-on"] : 0) + (i.rh ? PRICES["Remote Help Add-on"] : 0)) * mult;
                let suiteCost = PRICES["Intune Suite Add-on"] * mult;
                
                if (indCost > suiteCost) {
                    addons.push("Intune Suite Add-on"); reason += " + Intune Suite.";
                } else {
                    if (i.epm) addons.push("EPM Add-on");
                    if (i.rh) addons.push("Remote Help Add-on");
                }
            }

            if (i.serverProt) addons.push("Defender for Business Servers");
            if (i.copilot) addons.push("M365 Copilot");
            
            if (i.visio) addons.push("Visio Plan 2");
            if (i.project) addons.push("Project Plan 3");
            if (i.pauto) addons.push("Power Automate Premium");
            if (i.rooms) addons.push("Teams Rooms Pro");

            
            // Security & Compliance Add-ons Logic
            if (!base.includes("E5")) {
                if (base === "Business Premium") {
                     // NEW SMB LOGIC
                     if (needsAdvComp && needsAdvSec) {
                         addons.push("BizPrem E5 Upgrade");
                     } else if (needsAdvComp) {
                         addons.push("Purview Suite for BizPrem");
                     } else if (needsAdvSec) {
                         addons.push("Defender Suite for BizPrem");
                     }
                } else if (base.includes("F")) {
                    if (needsAdvComp) addons.push("M365 F5 Compliance Add-on");
                    if (needsAdvSec) addons.push("M365 F5 Security Add-on"); // F3 can use F5 Security
                } else {
                    // Enterprise (E3)
                    if (needsAdvComp) addons.push("M365 E5 Compliance Add-on");
                    if (needsAdvSec) addons.push("M365 E5 Security Add-on"); 
                }
            }

            let price = (PRICES[base] || 0) * mult; // Apply Mult to Base
            let flatAddons = [];
            addons.forEach(a => {
                if (typeof a === 'object') { price += a.price; flatAddons.push(a.name); }
                else { price += (PRICES[a] || 0) * mult; flatAddons.push(a); } // Apply Mult to Addons
            });

            // Auto Upsell
            if (i.style !== 'standalone' && base !== "M365 E5" && !base.includes("F")) { 
                // Calc E5 Price with Multiplier
                let e5P = (PRICES["M365 E5"] * mult) + (tPrice > 0 ? (PRICES["Teams_ME5"] * mult) : 0);
                let keep = [];
                if (i.teams && tPrice > 0) keep.push("Teams EEA");
                flatAddons.forEach(fa => {
                    // Addons NOT in E5 (Keep paying for them)
                    if (fa.includes("Copilot") || fa.includes("Visio") || fa.includes("Project") || fa.includes("Power") || fa.includes("Rooms") || fa.includes("Server") || fa.includes("Intune") || fa.includes("EPM") || fa.includes("Remote")) {
                        e5P += (PRICES[fa] || 0) * mult; 
                        keep.push(fa);
                    }
                });
                
                if (price > e5P) {
                    base = "M365 E5";
                    price = e5P;
                    flatAddons = keep;
                    reason = "Auto-Upgrade to M365 E5 (Cheaper than Base + Add-ons).";
                    tPrice = i.teams ? (PRICES["Teams_ME5"] * mult) : 0; 
                }
            }

            let feats = [...(FEATURES_MAP[base] || [])];
            if (i.teams) {
                feats = feats.filter(f => f !== "No Teams");
                if (!feats.includes("Teams Phone") && !feats.includes("Teams Collaboration")) feats.push("Teams Collaboration");
            }

            currentCalc = { base, addons: flatAddons, price, reason, count: i.count, features: feats, alt, currentLic: i.current, teamsPrice: tPrice };
            render();
        }

        function render() {
            const c = currentCalc;
            const mult = isMonthly ? 1.2 : 1.0;

            document.getElementById('recName').innerText = c.base;
            document.getElementById('recPrice').innerText = "€" + c.price.toFixed(2);
            document.getElementById('recReason').innerText = c.reason;
            
            // Delta
            const currentPrice = (PRICES[c.currentLic] || 0) * mult; 
            const delta = c.price - currentPrice;
            let deltaHtml = "";
            if (c.currentLic !== "None") {
                if (delta > 0) deltaHtml = `<span class="text-xs ml-2 text-red-300 font-semibold">+€${delta.toFixed(2)} Invest</span>`;
                else if (delta < 0) deltaHtml = `<span class="text-xs ml-2 text-green-300 font-semibold">-€${Math.abs(delta).toFixed(2)} Save</span>`;
            }
            document.getElementById('recPrice').innerHTML = `€${c.price.toFixed(2)} ${deltaHtml}`;

            let subHtml = c.addons.filter(a => !a.includes("Teams")).join(" + ");
            if(c.teamsPrice > 0) {
                subHtml = `<span class="text-blue-500 font-bold">Teams (+€${c.teamsPrice.toFixed(2)})</span>` + (subHtml ? " + " + subHtml : "");
            }
            document.getElementById('recAddon').innerHTML = subHtml || "";
            
            // Runner Up Fix
            document.getElementById('altName').innerText = c.alt;
            const altPrice = (PRICES[c.alt] || 0) * mult;
            document.getElementById('altPrice').innerText = "€" + altPrice.toFixed(2);
            
            const altDiff = c.price - altPrice;
            const altEl = document.getElementById('altDiff');
            if (altDiff > 0) {
                altEl.innerText = `+€${altDiff.toFixed(2)} more`;
                altEl.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-200";
            } else {
                altEl.innerText = `-€${Math.abs(altDiff).toFixed(2)} less`;
                altEl.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-green-100 text-green-600 dark:bg-green-900/50 dark:text-green-200";
            }

            const tags = document.getElementById('featureTags');
            tags.innerHTML = "";
            c.features.forEach(f => {
                tags.innerHTML += `<span class="inline-flex items-center rounded-md bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700 ring-1 ring-inset ring-indigo-700/10 dark:bg-indigo-900/30 dark:text-indigo-300 dark:ring-indigo-400/20">${f}</span>`;
            });
        }

        function addToQuote() {
            // CAPTURE INPUT STATE FOR EDITING LATER
            const inputState = {};
            FORM_IDS.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    inputState[id] = (el.type === 'checkbox') ? el.checked : el.value;
                }
            });

            const item = {...currentCalc, persona: document.getElementById('personaName').value || "Persona " + (quoteItems.length+1), inputs: inputState};

            if (editingIndex > -1) {
                // UPDATE EXISTING
                quoteItems[editingIndex] = item;
                editingIndex = -1; // Reset edit mode
                updateActionButton();
            } else {
                // ADD NEW
                quoteItems.push(item);
            }
            
            resetForm(); // Clear form after adding/updating
            renderTable();
        }

        function renderTable() {
            const tb = document.getElementById('quoteBody');
            tb.innerHTML = "";
            let grand = 0;
            
            // VARIABLES FOR DASHBOARD
            let totalBaseCost = 0;
            let totalAddonCost = 0;
            const mult = isMonthly ? 1.2 : 1.0;

            quoteItems.forEach((item, idx) => {
                const total = item.price * item.count;
                grand += total;
                
                // CALC SPLIT FOR DASHBOARD
                const baseUnit = (PRICES[item.base] || 0) * mult;
                const lineBase = baseUnit * item.count;
                const lineAddon = total - lineBase;
                
                totalBaseCost += lineBase;
                totalAddonCost += lineAddon;

                let addonHtml = item.addons.length > 0 
                    ? item.addons.map(a => {
                        let color = a.includes("Teams") ? "badge-blue" : a.includes("Security") ? "badge-red" : a.includes("Copilot") ? "badge-purple" : "badge-yellow";
                        return `<span class="badge ${color} mr-1 mb-1">${a}</span>`;
                    }).join("") 
                    : "<span class='text-slate-400 italic text-xs'>-</span>";

                // Edit Button Styling: Highlight if currently editing this row
                const editBtnStyle = (idx === editingIndex) ? "text-indigo-600 bg-indigo-50 rounded-full ring-2 ring-indigo-200" : "text-blue-500 hover:text-blue-600";

                tb.innerHTML += `
                <tr class="border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition ${idx === editingIndex ? 'bg-indigo-50/50' : ''}">
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${item.persona} <span class="text-xs text-slate-500 dark:text-slate-400 block">${item.count} Users</span></td>
                    <td class="px-6 py-4 text-indigo-900 dark:text-indigo-300 font-bold whitespace-nowrap">${item.base}</td>
                    <td class="px-6 py-4 leading-relaxed">${addonHtml}</td>
                    <td class="px-6 py-4 text-right whitespace-nowrap font-mono text-slate-600 dark:text-slate-300">€${item.price.toFixed(2)}</td>
                    <td class="px-6 py-4 text-right whitespace-nowrap font-bold font-mono text-primary-600 dark:text-primary-400">€${total.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center flex justify-center gap-3 items-center">
                        <button onclick="editPersona(${idx})" class="${editBtnStyle} transition p-1" title="Edit"><i class="fas fa-pen"></i></button>
                        <button onclick="showComparison(${idx})" class="text-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition p-1" title="Compare"><i class="fas fa-balance-scale"></i></button>
                        <button onclick="quoteItems.splice(${idx},1);renderTable()" class="text-red-400 hover:text-red-600 transition p-1" title="Remove"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            document.getElementById('grandTotal').innerText = "€" + grand.toFixed(2);
            document.getElementById('quoteCount').innerText = quoteItems.length + " Personas";

            // UPDATE DASHBOARD
            if (quoteItems.length > 0) {
                document.getElementById('costDashboard').style.display = "grid";
                
                const basePct = grand > 0 ? Math.round((totalBaseCost / grand) * 100) : 0;
                const addonPct = grand > 0 ? Math.round((totalAddonCost / grand) * 100) : 0;

                document.getElementById('dashBaseBar').style.width = basePct + "%";
                document.getElementById('dashAddonBar').style.width = addonPct + "%";

                document.getElementById('dashBaseVal').innerText = "€" + totalBaseCost.toFixed(2);
                document.getElementById('dashBasePct').innerText = basePct + "% of Total";
                
                document.getElementById('dashAddonVal').innerText = "€" + totalAddonCost.toFixed(2);
                document.getElementById('dashAddonPct').innerText = addonPct + "% of Total";
            } else {
                document.getElementById('costDashboard').style.display = "none";
            }
        }

        function showComparison(idx) {
            const item = quoteItems[idx];
            const curF = FEATURES_MAP[item.currentLic] || [];
            const recF = item.features || [];
            
            const rawGained = recF.filter(newFeature => {
                if (curF.includes(newFeature)) return false; 
                let groupName = null;
                for (const [grp, members] of Object.entries(HIERARCHY)) { if (members.includes(newFeature)) { groupName = grp; break; } }
                if (groupName) {
                    const members = HIERARCHY[groupName];
                    const newRank = members.indexOf(newFeature);
                    const hasSuperior = curF.some(oldF => { const oldRank = members.indexOf(oldF); return oldRank > -1 && oldRank >= newRank; });
                    if (hasSuperior) return false; 
                }
                return true;
            });

            const smartLost = curF.filter(lostFeature => {
                if (recF.includes(lostFeature)) return false; 
                let groupName = null;
                for (const [grp, members] of Object.entries(HIERARCHY)) { if (members.includes(lostFeature)) { groupName = grp; break; } }
                if (groupName) {
                    const members = HIERARCHY[groupName];
                    const lostRank = members.indexOf(lostFeature);
                    const hasSuperiorOrEqual = recF.some(f => { const r = members.indexOf(f); return r > -1 && r >= lostRank; });
                    if (hasSuperiorOrEqual) return false; 
                }
                return true;
            });

            document.getElementById('modCurrentName').innerText = item.currentLic;
            document.getElementById('modRecName').innerText = item.base;
            
            const gList = document.getElementById('listGained');
            gList.innerHTML = rawGained.length 
                ? rawGained.map(f => `<li class="flex items-start gap-2"><i class="fas fa-check text-green-500 mt-1"></i><span>${f}</span></li>`).join('') 
                : '<li class="italic text-slate-400">No new features</li>';

            const lList = document.getElementById('listLost');
            lList.innerHTML = smartLost.length 
                ? smartLost.map(f => `<li class="flex items-start gap-2"><i class="fas fa-times text-red-500 mt-1"></i><span>${f}</span></li>`).join('') 
                : '<li class="italic text-slate-400">No features lost</li>';
                
            document.getElementById('compModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('compModal').classList.add('hidden'); }
        
        // ---------------------------------------------------------
        // DATA MANAGEMENT (EXPORT & IMPORT)
        // ---------------------------------------------------------

        function escapeCSV(str) {
            if (!str) return "";
            // Prevent Injection: if starts with = + - @
            if (/^[=+\-@]/.test(str)) {
                return "'" + str;
            }
            return str.replace(/"/g, '""'); // Escape quotes
        }

        function exportCSV() {
            if (!quoteItems.length) return alert("Die Liste ist leer. Bitte füge erst Personas hinzu.");
            
            // Header
            let csv = "Persona,Count,Base,Addons,Price,Total,CurrentLic\n";
            
            csv += quoteItems.map(i => {
                // Sanitized Output
                const pName = escapeCSV(i.persona);
                const pBase = escapeCSV(i.base);
                const pAddons = escapeCSV(i.addons.join('|'));
                const pCur = escapeCSV(i.currentLic);
                
                return `"${pName}",${i.count},"${pBase}","${pAddons}",${i.price},${(i.price * i.count).toFixed(2)},"${pCur}"`;
            }).join("\n");

            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = 'M365_Quote_Export.csv';
            a.click();
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');

                let importedCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // CSV Parser
                    const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);

                    if (cols.length < 5) continue; 

                    const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';

                    const newItem = {
                        persona: clean(cols[0]),
                        count: parseInt(cols[1]) || 1,
                        base: clean(cols[2]),
                        addons: clean(cols[3]) ? clean(cols[3]).split('|') : [],
                        price: parseFloat(cols[4]) || 0,
                        currentLic: cols[6] ? clean(cols[6]) : "None" 
                    };

                    // Reconstruct Features
                    newItem.features = [...(FEATURES_MAP[newItem.base] || [])];
                    if(newItem.addons.some(a => a.includes("Teams"))) {
                        newItem.features = newItem.features.filter(f => f !== "No Teams");
                        if(!newItem.features.includes("Teams Collaboration")) newItem.features.push("Teams Collaboration");
                    }

                    // Note: Imported items do NOT have 'inputs' state, so they are not fully editable yet.
                    // Future improvement: Reverse-engineer inputs from base/addons.
                    quoteItems.push(newItem);
                    importedCount++;
                }

                renderTable();
                alert(`${importedCount} Personas erfolgreich importiert!`);
                input.value = ''; 
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
